<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FireGPT - AI Chat Interface</title>
  <style>
    /* ====== CSS Variables ====== */
    :root {
      --bg-dark: #1a1a1a;
      --bg-secondary: #2d2d2d;
      --bg-tertiary: #404040;
      --border-color: #404040;
      --accent: #6b9eff;
      --accent-hover: #5a8bef;
      --text-light: #ffffff;
      --text-muted: #909090;
    }

    /* Light theme overrides */
    html[data-theme="light"] {
      --bg-dark: #ffffff;
      --bg-secondary: #f5f5f5;
      --bg-tertiary: #e0e0e0;
      --border-color: #cccccc;
      --accent: #6b9eff;
      --accent-hover: #5a8bef;
      --text-light: #000000;
      --text-muted: #606060;
    }

    :root {
      --padding-base: 16px;
      --radius: 8px;
      --transition: 0.3s;
      color-scheme: light dark;
    }

    /* ====== Reset ====== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
      width: 100%;
      overflow: hidden;
      background: var(--bg-dark);
      color: var(--text-light);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    /* ====== Layout ====== */
    .container {
      display: flex;
      height: 100%;
    }

    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 var(--padding-base);
      z-index: 1000;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Theme toggle button */
    .theme-toggle {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
    }

    .theme-toggle img {
      width: 24px;
      height: 24px;
    }

    html[data-theme="dark"] .theme-toggle img {
      filter: none;
    }

    html[data-theme="light"] .theme-toggle img {
      filter: invert(100%);
    }

    /* ====== Sidebars ====== */
    .sidebar,
    .right-sidebar {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      padding-top: 60px;
      display: flex;
      flex-direction: column;
      width: 220px;
    }

    .sidebar {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      padding-top: 60px;
      display: flex;
      flex-direction: column;
      position: relative;
      flex: 0 0 auto;
      width: 350px;
      min-width: 300px;
    }

    .right-sidebar {
      flex: 0.7 1 220px;
    }

    .sidebar-header {
      padding: var(--padding-base);
      border-bottom: 1px solid var(--border-color);
    }

    .sidebar-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: var(--padding-base);
    }

    /* Add Documents button */
    .add-btn {
      background: var(--bg-tertiary);
      border: none;
      color: var(--text-light);
      padding: 8px;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 14px;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: filter var(--transition);
    }

    .add-btn img {
      width: 24px;
      height: 24px;
    }

    html[data-theme="dark"] .add-btn img {
      filter: none;
    }

    html[data-theme="light"] .add-btn img {
      filter: invert(100%);
    }

    .add-btn span {
      display: inline-block;
    }

    .add-btn:hover {
      filter: brightness(1.1);
    }

    .sources-section {
      flex: 1;
      overflow-y: auto;
      padding: var(--padding-base);
    }

    .source-item {
      padding: 8px 0;
      font-size: 14px;
      color: var(--text-muted);
      word-break: break-all;
    }

    .source-item button:hover {
      color: #d32f2f;
    }


    /* ====== Main ====== */
    .main-content {
      display: flex;
      flex: 1.3 1 0;
      height: 100%;
      padding-top: 60px;
    }

    .chat-container {
      display: flex;
      flex-direction: column;
      width: 100%;
    }

    .chat-header {
      padding: var(--padding-base);
      border-bottom: 1px solid var(--border-color);
    }

    .chat-title {
      font-size: 18px;
      font-weight: 600;
    }

    .messages-area {
      flex: 1;
      padding: var(--padding-base);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .message {
      max-width: 80%;
      padding: 12px var(--padding-base);
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.5;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      word-break: break-word;
    }

    .message.user {
      background: #0078d4;
      /* vivid blue for strong contrast */
      color: #ffffff;
      align-self: flex-end;
    }

    .message.assistant {
      background: #353535;
      /* darker, higher contrast */
      color: #ffffff;
      align-self: flex-start;
    }

    .message img {
      max-width: 200px;
      border-radius: 6px;
      margin-top: 8px;
    }

    /* ====== Input ====== */
    .input-area {
      position: sticky;
      bottom: 0;
      background: var(--bg-secondary);
      padding: var(--padding-base);
      border-top: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 500;
    }

    .preview-area {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      max-height: calc(50px * 2 + 8px);
      overflow-y: auto;
    }

    .preview-area img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: var(--radius);
    }

    .input-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chat-input {
      flex: 1;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      /* tighten initial height to one line */
      padding: 8px;
      line-height: 1.8;
      min-height: calc(1.8em + 18px);
      /* auto-resize up to max */
      max-height: 160px;
      overflow-y: auto;
      color: var(--text-light);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 14px;
      resize: none;
      transition: border-color var(--transition);
      direction: rtl;
      unicode-bidi: plaintext;
      text-align: left;
    }

    /* Custom scrollbar for input area */
    .chat-input::-webkit-scrollbar {
      width: 6px;
    }

    .chat-input::-webkit-scrollbar-track {
      background: transparent;
    }

    .chat-input::-webkit-scrollbar-thumb {
      background-color: var(--text-muted);
      border-radius: 3px;
    }

    /* Firefox scrollbar */
    .chat-input {
      scrollbar-width: thin;
      scrollbar-color: var(--text-muted) transparent;
    }

    .chat-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .chat-input::placeholder {
      color: var(--text-muted);
    }

    .file-btn,
    .send-btn {
      background: var(--bg-tertiary);
      border: none;
      color: var(--text-light);
      width: 44px;
      height: 44px;
      border-radius: var(--radius);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: filter var(--transition);
      padding: 0;
    }

    .file-btn img,
    .send-btn img {
      width: 24px;
      height: 24px;
    }

    html[data-theme="dark"] .file-btn img,
    html[data-theme="dark"] .send-btn img {
      filter: none;
    }

    html[data-theme="light"] .file-btn img,
    html[data-theme="light"] .send-btn img {
      filter: invert(100%);
    }

    .file-btn:hover,
    .send-btn:hover:not(:disabled) {
      filter: brightness(1.2);
    }

    .send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ====== Map ====== */
    .map-container {
      flex: 1;
      padding: var(--padding-base);
    }

    .map-frame {
      width: 100%;
      height: 100%;
      border: none;
      border-radius: var(--radius);
    }

    /* ====== Responsive ====== */
    @media (max-width: 768px) {

      .sidebar,
      .right-sidebar {
        width: 250px;
      }
    }

    @media (max-width: 640px) {

      .sidebar,
      .right-sidebar {
        position: fixed;
        top: 60px;
        height: calc(100% - 60px);
        transition: transform var(--transition);
      }

      .sidebar {
        transform: translateX(-100%);
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .right-sidebar {
        transform: translateX(100%);
        width: 90%;
      }

      .right-sidebar.open {
        transform: translateX(-10%);
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <header class="header">
      <div class="logo">
        <div class="logo-icon">ðŸ”¥</div>
        <div class="logo-text">FireGPT</div>
      </div>
      <button class="theme-toggle" onclick="toggleTheme()"><img src="./icons/darklight.png"
          alt="Toggle Theme" /></button>
    </header>

    <aside class="sidebar">
      <div class="sidebar-header">
        <h2 class="sidebar-title">Sources</h2>
        <div style="display: flex; gap: 8px; align-items: center;">
          <button class="add-btn" onclick="fileInput.click()">
            <img src="./icons/adddocuments.png" alt="Add Documents" />
            <span>Add Documents</span>
          </button>
          <button class="add-btn" onclick="removeAllDocuments()" style="background: #d32f2f;" title="Remove All">
            <img src="./icons/delete.png" alt="Remove All" /><span>Remove All</span>
          </button>
        </div>
        <input id="fileInput" type="file" accept="application/pdf" multiple hidden />
      </div>
      <div class="sources-section" id="sourcesList"></div>
    </aside>

    <main class="main-content">
      <section class="chat-container">
        <div class="chat-header">
          <h1 class="chat-title">Chat</h1>
        </div>
        <div class="messages-area" id="messagesArea">
          <div class="message assistant">Welcome to FireGPT! I'm here to help you with your questions and tasks.</div>
        </div>
        <div class="input-area">
          <div class="preview-area" id="previewArea"></div>
          <div class="input-row">
            <textarea class="chat-input" placeholder="Start typing..." rows="1"></textarea>
            <button class="file-btn" onclick="imageInput.click()"><img src="./icons/addimage.png"
                alt="Add Image" /></button>
            <button class="send-btn" disabled><img src="./icons/send.png" alt="Send" /></button>
            <input id="imageInput" type="file" accept="image/*" multiple hidden />
          </div>
        </div>
      </section>
    </main>
    <aside class="right-sidebar">
      <div class="map-container"><iframe src="map.html" class="map-frame" title="Emergency Response Map"></iframe></div>
    </aside>
  </div>
  <script>
    // Theme toggle logic
    function toggleTheme() {
      const html = document.documentElement;
      const current = html.getAttribute('data-theme');
      const next = current === 'dark' ? 'light' : 'dark';
      html.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
    }
    // Initialize theme from storage
    (function () {
      const saved = localStorage.getItem('theme') || 'dark';
      document.documentElement.setAttribute('data-theme', saved);
    })();

    const fileInput = document.getElementById('fileInput');
    const sourcesList = document.getElementById('sourcesList');
    const imageInput = document.getElementById('imageInput');
    const previewArea = document.getElementById('previewArea');
    const chatInput = document.querySelector('.chat-input');
    const sendBtn = document.querySelector('.send-btn');
    const messagesArea = document.getElementById('messagesArea');
    let uploadedFiles = [];

    // Auto-resize textarea up to 5 lines (~130px)
    chatInput.addEventListener('input', () => {
      // resize logic
      chatInput.style.height = 'auto';
      const maxHeight = 160; // approx. 6 lines // approx. 5 lines
      chatInput.style.height = Math.min(chatInput.scrollHeight, maxHeight) + 'px';
      // enable send
      sendBtn.disabled = !chatInput.value.trim() && !imageInput.files.length;
    });

    imageInput.addEventListener('change', () => {
      previewArea.innerHTML = '';
      Array.from(imageInput.files).forEach(file => {
        const url = URL.createObjectURL(file);
        const img = document.createElement('img');
        img.src = url;
        previewArea.appendChild(img);
      });
      sendBtn.disabled = false;
    });

    /*---------------------------------------------------*/
    async function sendMessage() {
      const text = chatInput.value.trim();
      const images = Array.from(imageInput.files);

      // Show user message in UI
      if (text) appendMessage(text, 'user');
      for (const img of images) {
        const reader = new FileReader();
        reader.onload = e => appendImage(e.target.result, 'user');
        reader.readAsDataURL(img);
      }

      // Prepare form data
      const formData = new FormData();
      formData.append("message", text);
      images.forEach((file, index) => {
        formData.append("images", file); // FastAPI will receive as a list
      });

      // Send to backend
      try {
        const response = await fetch("http://localhost:8000/send-chat", {
          method: "POST",
          body: formData,
        });

        const result = await response.json();
        if (response.ok) {
          if (result.reply) appendMessage(result.reply, 'assistant');
        } else {
          appendMessage("Error: " + result.detail, 'assistant');
        }
      } catch (err) {
        console.error("Send failed:", err);
        appendMessage("Network error", 'assistant');
      }

      // Reset inputs
      chatInput.value = '';
      imageInput.value = '';
      previewArea.innerHTML = '';
      chatInput.style.height = 'auto';
      sendBtn.disabled = true;
    }
    /*---------------------------------------------------*/

    sendBtn.addEventListener('click', sendMessage);
    chatInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });

    function appendMessage(text, role) {
      const msg = document.createElement('div'); msg.className = `message ${role}`; msg.textContent = text;
      messagesArea.appendChild(msg); messagesArea.scrollTop = messagesArea.scrollHeight;
    }
    function appendImage(src, role) {
      const msg = document.createElement('div'); msg.className = `message ${role}`;
      const img = document.createElement('img'); img.src = src; msg.appendChild(img);
      messagesArea.appendChild(msg); messagesArea.scrollTop = messagesArea.scrollHeight;
    }

    async function removeAllDocuments() {
      try {
        const response = await fetch("http://localhost:8000/delete-all", {
          method: "DELETE",
        });
        if (response.ok) {
          uploadedFiles = [];
          sourcesList.innerHTML = '';
        } else {
          alert('Failed to delete all documents');
        }
      } catch (err) {
        console.error('Error deleting all documents:', err);
        alert('Network error while deleting documents');
      }
    }

    fileInput.addEventListener('change', async function () {
      const files = Array.from(this.files);
      for (const file of files) {
        if (!uploadedFiles.includes(file.name)) {
          const formData = new FormData();
          formData.append('file', file);
          try {
            const response = await fetch('http://localhost:8000/upload', {
              method: 'POST',
              body: formData,
            });

            if (response.ok) {
              uploadedFiles.push(file.name);
              addSourceItem(file.name);
            } else {
              alert('Upload failed: ' + (await response.text()));
            }
          } catch (err) {
            console.error('Error uploading file:', err);
            alert('Upload failed: Network error');
          }
        }
      }
      fileInput.value = '';
    });

    // âœ… NEW: Load uploaded files from backend on page load
    async function loadUploadedFiles() {
      try {
        const response = await fetch("http://localhost:8000/list-files");
        if (response.ok) {
          const files = await response.json();
          uploadedFiles = files;
          files.forEach(filename => addSourceItem(filename));
        } else {
          console.error("Failed to fetch file list.");
        }
      } catch (err) {
        console.error("Error fetching uploaded files:", err);
      }
    }

    // âœ… Add a file to the source list in UI
    function addSourceItem(filename) {
      const div = document.createElement('div');
      div.className = 'source-item';
      div.textContent = filename;

      const removeBtn = document.createElement('button');
      removeBtn.textContent = 'âœ•';
      removeBtn.style.marginLeft = '10px';
      removeBtn.style.background = 'none';
      removeBtn.style.border = 'none';
      removeBtn.style.color = 'inherit';
      removeBtn.style.cursor = 'pointer';

      removeBtn.onclick = async function () {
        try {
          const response = await fetch(`http://localhost:8000/delete/${encodeURIComponent(filename)}`, {
            method: 'DELETE'
          });
          if (response.ok) {
            uploadedFiles = uploadedFiles.filter(f => f !== filename);
            div.remove();
          } else {
            alert(`Failed to delete file: ${filename}`);
          }
        } catch (err) {
          console.error('Error deleting file:', err);
          alert('Network error while deleting file');
        }
      };

      div.appendChild(removeBtn);
      sourcesList.appendChild(div);
    }

    // âœ… Load on page ready
    window.addEventListener("DOMContentLoaded", loadUploadedFiles);
  </script>
</body>

</html>